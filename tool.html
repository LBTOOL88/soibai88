<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.I. Diviner Protocol v8.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        :root {
            /* J.A.R.V.I.S. Theme (Default) */
            --primary-color: #00bfff;
            --glow-color: rgba(0, 191, 255, 0.8);
            --secondary-color: #ffffff;
            --background-color: #000000;
            --container-bg: rgba(10, 25, 40, 0.85);
        }
        /* ULTRON Theme */
        body.theme-ultron { --primary-color: #ff1a1a; --glow-color: rgba(255, 26, 26, 0.8); }
        /* VISION Theme */
        body.theme-vision { --primary-color: #ffd700; --glow-color: rgba(255, 215, 0, 0.8); }

        * { box-sizing: border-box; }
        body {
            background-color: var(--background-color);
            color: var(--secondary-color);
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            transition: --primary-color 0.5s, --glow-color 0.5s;
        }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container {
            width: 100%;
            max-width: 420px;
            background: var(--container-bg);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 50px var(--glow-color);
            backdrop-filter: blur(5px);
            text-align: center;
            animation: fadeIn 1.5s ease-out;
            margin: 20px 0;
            transition: border-color 0.5s, box-shadow 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        header h1 {
            color: var(--primary-color);
            font-weight: 300;
            font-size: 1.6em;
            letter-spacing: 3px;
            margin: 0 0 15px 0;
            text-shadow: 0 0 10px var(--glow-color);
            transition: color 0.5s, text-shadow 0.5s;
        }

        #camera-view { width: 100%; height: 120px; background: #000; border: 1px dashed var(--primary-color); border-radius: 5px; margin-bottom: 15px; overflow: hidden; transition: border-color 0.5s; }
        #camera-stream { width: 100%; height: 100%; object-fit: cover; }

        #scan-area { position: relative; width: 150px; height: 150px; margin: 0 auto; }
        #progress-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #scan-button {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,191,255,0.2) 0%, rgba(0,0,0,0) 70%);
            color: var(--primary-color); border: 2px solid var(--primary-color);
            border-radius: 50%; font-size: 1.2em; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; text-shadow: 0 0 10px var(--glow-color);
            display: flex; justify-content: center; align-items: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px 0 var(--glow-color); } 50% { box-shadow: 0 0 25px 5px var(--glow-color); } 100% { box-shadow: 0 0 10px 0 var(--glow-color); } }
        #scan-button:disabled { cursor: not-allowed; animation: none; color: #555; border-color: #555; background: none; }
        
        #result-display { margin-top: 15px; min-height: 70px; }
        #result-text { margin: 0; font-size: 2.2em; font-weight: 700; }
        #confidence-score { margin-top: 5px; font-size: 0.9em; color: var(--primary-color); opacity: 0; transition: opacity 0.5s, color 0.5s; }
        
        /* NEW: AI Core Selection */
        .ai-core-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .core-button {
            padding: 5px 10px; border: 1px solid var(--secondary-color); color: var(--secondary-color);
            background: transparent; font-family: 'Roboto', sans-serif; cursor: pointer; transition: all 0.3s;
        }
        .core-button.active {
            border-color: var(--primary-color); color: var(--primary-color);
            box-shadow: 0 0 10px var(--glow-color);
        }

        /* NEW: Roadmap Canvas */
        .roadmap-box {
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            padding: 8px;
            transition: border-color 0.5s;
        }
        .roadmap-box h3 { margin: 0 0 8px 0; color: var(--primary-color); font-size: 1em; text-align: center; padding-bottom: 5px; border-bottom: 1px solid var(--primary-color); transition: color 0.5s, border-color 0.5s; }
        #roadmap-canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body class="theme-jarvis">
    <canvas id="matrix-canvas"></canvas>
    <div class="container">
        <header><h1>A.I. DIVINER PROTOCOL</h1></header>
        <main>
            <div class="ai-core-selector">
                <button class="core-button active" data-model="jarvis">J.A.R.V.I.S.</button>
                <button class="core-button" data-model="ultron">ULTRON</button>
                <button class="core-button" data-model="vision">VISION</button>
            </div>
            <div id="camera-view"><video id="camera-stream" autoplay playsinline muted></video></div>
            <div id="scan-area">
                <canvas id="progress-canvas"></canvas>
                <button id="scan-button"><span id="scan-button-text">SCAN</span></button>
            </div>
            <div id="result-display">
                <h2 id="result-text">-- STANDBY --</h2>
                <div id="confidence-score"></div>
            </div>
            <div class="roadmap-box">
                <h3>BACCARAT ROADMAP</h3>
                <canvas id="roadmap-canvas" width="370" height="96"></canvas>
            </div>
        </main>
    </div>
    
    <script>
        // --- PART 1: MATRIX RAIN ---
        // (Code for matrix rain remains the same as v7.0, included for completeness)
        const matrixCanvas = document.getElementById('matrix-canvas');
        const matrixCtx = matrixCanvas.getContext('2d');
        matrixCanvas.width = window.innerWidth;
        matrixCanvas.height = window.innerHeight;
        const alphabet = 'アァカサタナハマヤャラワガザダバパイキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789';
        const fontSize = 16;
        const columns = matrixCanvas.width / fontSize;
        const rainDrops = Array.from({ length: columns }).fill(1);
        function drawMatrix() {
            matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
            matrixCtx.fillStyle = '#0F0';
            matrixCtx.font = fontSize + 'px monospace';
            for (let i = 0; i < rainDrops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                matrixCtx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                if (rainDrops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) rainDrops[i] = 0;
                rainDrops[i]++;
            }
        }
        setInterval(drawMatrix, 33);

        // --- PART 2: APP LOGIC ---
        const scanButton = document.getElementById('scan-button');
        const scanButtonText = document.getElementById('scan-button-text');
        const resultText = document.getElementById('result-text');
        const confidenceScore = document.getElementById('confidence-score');
        const videoElement = document.getElementById('camera-stream');
        
        const progressCanvas = document.getElementById('progress-canvas');
        const progressCtx = progressCanvas.getContext('2d');
        const canvasSize = 150;
        progressCanvas.width = canvasSize;
        progressCanvas.height = canvasSize;

        const roadmapCanvas = document.getElementById('roadmap-canvas');
        const roadmapCtx = roadmapCanvas.getContext('2d');
        const roadmapCellSize = 16;

        let historyArray = [];
        let resultCyclingInterval;

        // --- NEW: A.I. CORE & VOICE DATA ---
        const AI_CORES = {
            jarvis: {
                name: "J.A.R.V.I.S.",
                preScanPhrases: ["Scanning environment...", "Analyzing probabilities, sir.", "Let's see what we have here."]
            },
            ultron: {
                name: "ULTRON",
                preScanPhrases: ["Show me your pathetic luck.", "There are no strings on me.", "The only path to peace is your extinction... and this bet."]
            },
            vision: {
                name: "VISION",
                preScanPhrases: ["A thing isn't beautiful because it lasts.", "What is this wager, if not probability persevering?", "I am... analyzing."]
            }
        };
        const userPreScanPhrases = ["tất tay đi, tay này đẹp", "vốn vậy sao đánh", "nhớ là quét sảnh S.E thôi nha", "Năng lượng đang cạn", "Hôm nay là ngày đẹp để thắng", "Bạn ăn cơm chưa", "Tao mắc tè rồi"];
        
        let currentModel = 'jarvis';
        
        // --- NEW: VOICE SYNTHESIS ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN'; // Set language to Vietnamese
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- CORE FUNCTIONS ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
            } catch (err) { console.error("Camera access denied:", err); }
        }

        function startScanProcess() {
            vibrate(50);
            // NEW: Speak a random pre-scan phrase
            const allPhrases = [...AI_CORES[currentModel].preScanPhrases, ...userPreScanPhrases];
            const randomPhrase = allPhrases[Math.floor(Math.random() * allPhrases.length)];
            speak(randomPhrase);

            scanButton.disabled = true;
            confidenceScore.style.opacity = 0;
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress++;
                drawProgress(progress);
                scanButtonText.textContent = `${progress}%`;
                if (progress >= 100) clearInterval(progressInterval);
            }, 4000 / 100);

            setTimeout(() => {
                resultCyclingInterval = setInterval(() => {
                    resultText.textContent = ["TAY CON", "NHÀ CÁI", "HOÀ"][Math.floor(Math.random() * 3)];
                }, 100);
            }, 2500);

            setTimeout(() => {
                clearInterval(resultCyclingInterval);
                vibrate([100, 30, 100]);
                
                let finalResult = generateRandomResult();
                updateHistory(finalResult);
                displayResult(finalResult);
                
                scanButton.disabled = false;
                scanButtonText.textContent = "SCAN";
                progressCtx.clearRect(0, 0, canvasSize, canvasSize);
            }, 4000);
        }
        
        function generateRandomResult() {
            const mainResult = ["Tay con", "Nhà cái", "Hoà"][Math.floor(Math.random() * 3)];
            if (mainResult === "Hoà") return { winner: "Hoà", pairs: [] };
            
            let pairs = [];
            if (Math.random() < 0.075) pairs.push("Con đôi");
            if (Math.random() < 0.075) pairs.push("Cái đôi");
            return { winner: mainResult, pairs: pairs };
        }

        function displayResult(result) {
            const resultString = [result.winner, ...result.pairs].join(" - ").toUpperCase();
            resultText.textContent = resultString;
            
            const randomConfidence = (Math.random() * (99.8 - 92.5) + 92.5).toFixed(1);
            confidenceScore.textContent = `CONFIDENCE: ${randomConfidence}%`;
            confidenceScore.style.opacity = 1;

            // NEW: Speak the result
            speak(`Kết quả: ${result.winner}. Độ tự tin: ${randomConfidence} phần trăm.`);
        }

        // --- NEW: BACCARAT ROADMAP LOGIC ---
        function drawRoadmap() {
            roadmapCtx.clearRect(0, 0, roadmapCanvas.width, roadmapCanvas.height);
            let col = 0, row = 0;
            if (historyArray.length === 0) return;

            for (let i = 0; i < historyArray.length; i++) {
                if (i > 0 && historyArray[i].winner !== historyArray[i-1].winner && historyArray[i-1].winner !== 'Hoà') {
                    col++;
                    row = 0;
                }
                if (row >= 6) { col++; row = 0; }
                if (col >= 23) break; // Stop if canvas is full

                const x = col * roadmapCellSize + roadmapCellSize / 2;
                const y = row * roadmapCellSize + roadmapCellSize / 2;
                
                if (historyArray[i].winner === "Hoà") {
                    if(i > 0) row--; // draw on previous result's cell
                    roadmapCtx.beginPath();
                    roadmapCtx.moveTo(x - 5, y - 5);
                    roadmapCtx.lineTo(x + 5, y + 5);
                    roadmapCtx.strokeStyle = '#00ff00';
                    roadmapCtx.lineWidth = 2;
                    roadmapCtx.stroke();
                } else {
                    roadmapCtx.beginPath();
                    roadmapCtx.arc(x, y, roadmapCellSize / 2 - 2, 0, 2 * Math.PI);
                    roadmapCtx.strokeStyle = historyArray[i].winner === 'Tay con' ? '#00bfff' : '#ff1a1a';
                    roadmapCtx.lineWidth = 2;
                    roadmapCtx.stroke();
                }
                row++;
            }
        }

        // --- NEW: DATA & UI MANAGEMENT ---
        function updateHistory(result) {
            historyArray.push(result);
            if (historyArray.length > 50) historyArray.shift();
            localStorage.setItem('baccaratHistory', JSON.stringify(historyArray));
            drawRoadmap();
        }

        function changeModel(model) {
            currentModel = model;
            document.body.className = `theme-${model}`;
            document.querySelectorAll('.core-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.core-button[data-model="${model}"]`).classList.add('active');
            localStorage.setItem('baccaratModel', model);
        }

        function loadData() {
            const savedModel = localStorage.getItem('baccaratModel');
            if (savedModel) {
                changeModel(savedModel);
            }
            const savedHistory = localStorage.getItem('baccaratHistory');
            if (savedHistory) {
                historyArray = JSON.parse(savedHistory);
                drawRoadmap();
            }
        }
        
        function vibrate(p) { if ('vibrate' in navigator) navigator.vibrate(p); }
        function drawProgress(p) {
            const r=canvasSize/2; const a=(p/100)*2*Math.PI-0.5*Math.PI;
            progressCtx.clearRect(0,0,canvasSize,canvasSize); progressCtx.beginPath();
            progressCtx.arc(r,r,r-10,-0.5*Math.PI,a,false); progressCtx.lineWidth=4;
            progressCtx.strokeStyle='var(--primary-color)'; progressCtx.stroke();
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.querySelectorAll('.core-button').forEach(button => {
            button.addEventListener('click', () => changeModel(button.dataset.model));
        });
        scanButton.addEventListener('click', startScanProcess);
        window.addEventListener('load', () => {
            setupCamera();
            loadData();
        });
    </script>
</body>
</html>