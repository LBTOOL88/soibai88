<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.I. Diviner Protocol v10.2 - Bug Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        :root {
            --primary-color: #00bfff; --glow-color: rgba(0, 191, 255, 0.8);
            --secondary-color: #ffffff; --background-color: #000000;
            --container-bg: rgba(10, 25, 40, 0.85); --error-color: #ff1a1a;
            --success-color: #00ff7f;
        }
        body.theme-ultron { --primary-color: #ff1a1a; --glow-color: rgba(255, 26, 26, 0.8); }
        body.theme-vision { --primary-color: #ffd700; --glow-color: rgba(255, 215, 0, 0.8); }
        * { box-sizing: border-box; }
        body { background-color: var(--background-color); color: var(--secondary-color); font-family: 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; overflow: hidden; transition: --primary-color 0.5s, --glow-color 0.5s; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container { display: none; width: 100%; max-width: 420px; background: var(--container-bg); border: 1px solid var(--primary-color); border-radius: 15px; padding: 20px; box-shadow: 0 0 50px var(--glow-color); backdrop-filter: blur(5px); text-align: center; animation: fadeIn 1.5s ease-out; margin: 20px 0; transition: border-color 0.5s, box-shadow 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        header { position: relative; }
        header h1 { color: var(--primary-color); font-weight: 300; font-size: 1.6em; letter-spacing: 3px; margin: 0 0 15px 0; text-shadow: 0 0 10px var(--glow-color); transition: color 0.5s, text-shadow 0.5s; }
        #camera-view { width: 100%; height: 120px; background: #000; border: 1px dashed var(--primary-color); border-radius: 5px; margin-bottom: 15px; overflow: hidden; transition: border-color 0.5s; }
        #camera-stream { width: 100%; height: 100%; object-fit: cover; }
        #scan-area { position: relative; width: 150px; height: 150px; margin: 0 auto; }
        #progress-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #scan-button { position: relative; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,191,255,0.2) 0%, rgba(0,0,0,0) 70%); color: var(--primary-color); border: 2px solid var(--primary-color); border-radius: 50%; font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; text-shadow: 0 0 10px var(--glow-color); display: flex; justify-content: center; align-items: center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 10px 0 var(--glow-color); } 50% { box-shadow: 0 0 25px 5px var(--glow-color); } 100% { box-shadow: 0 0 10px 0 var(--glow-color); } }
        #scan-button:disabled { cursor: not-allowed; animation: none; color: #555; border-color: #555; background: none; }
        #result-display { margin-top: 15px; min-height: 70px; }
        #result-text { margin: 0; font-size: 2.2em; font-weight: 700; }
        #confidence-score { margin-top: 5px; font-size: 0.9em; color: var(--primary-color); opacity: 0; transition: opacity 0.5s, color 0.5s; }
        .ai-core-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .core-button { padding: 5px 10px; border: 1px solid var(--secondary-color); color: var(--secondary-color); background: transparent; font-family: 'Roboto', sans-serif; cursor: pointer; transition: all 0.3s; }
        .core-button.active { border-color: var(--primary-color); color: var(--primary-color); box-shadow: 0 0 10px var(--glow-color); }
        .roadmap-box { margin-top: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--primary-color); border-radius: 5px; padding: 8px; transition: border-color 0.5s; }
        .roadmap-box h3 { margin: 0 0 8px 0; color: var(--primary-color); font-size: 1em; text-align: center; padding-bottom: 5px; border-bottom: 1px solid var(--primary-color); transition: color 0.5s, border-color 0.5s; }
        #roadmap-canvas { display: block; margin: 0 auto; }

        /* --- DANGEROUS/FLASHING STYLES --- */
        @keyframes ultron-warning-flash { 0%, 100% { box-shadow: 0 0 20px var(--error-color), inset 0 0 10px rgba(255, 26, 26, 0.5); border-color: var(--error-color); } 50% { box-shadow: 0 0 70px rgba(255, 26, 26, 1), inset 0 0 30px rgba(255, 26, 26, 1); border-color: #ffffff; } }
        @keyframes dangerous-pulse { 0%, 100% { box-shadow: 0 0 30px var(--glow-color); } 50% { box-shadow: 0 0 60px var(--glow-color); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-box { background: var(--container-bg); border: 1px solid var(--primary-color); border-radius: 15px; padding: 25px 30px; box-shadow: 0 0 60px var(--glow-color); text-align: center; max-width: 400px; }
        .modal-box h2 { color: var(--primary-color); margin-top: 0; font-weight: 400; letter-spacing: 2px; }
        .modal-box p { margin: 15px 0; line-height: 1.6; font-size: 1.1em; }
        .modal-input { width: 100%; background: #000; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 12px; margin-bottom: 15px; border-radius: 5px; font-size: 1.2em; text-align: center; letter-spacing: 3px; }
        .modal-button { width: 100%; padding: 12px; background: var(--primary-color); color: #000; border: none; border-radius: 5px; font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .modal-button:hover { box-shadow: 0 0 20px var(--glow-color); }
        .modal-button-group { display: flex; gap: 15px; margin-top: 20px; }
        .modal-button.secondary { background: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color); }
        #login-error { color: var(--error-color); min-height: 20px; font-weight: 700; }
        
        #login-overlay .modal-box { --primary-color: #ff1a1a; --glow-color: rgba(255, 26, 26, 0.7); animation: fadeIn 0.5s, dangerous-pulse 3s infinite; }
        #ultron-warning-modal .modal-box { --error-color: #ff1a1a; animation: fadeIn 0.3s, ultron-warning-flash 1s infinite; }
        #ultron-warning-modal h2 { color: var(--error-color); }
        #ultron-warning-modal .modal-button { background: var(--error-color); }

        /* --- UPGRADED COIN DISPLAY --- */
        @keyframes coin-update-flash { 0% { background-color: rgba(255, 215, 0, 0); } 50% { background-color: rgba(255, 215, 0, 0.7); } 100% { background-color: rgba(255, 215, 0, 0); } }
        #coin-display { position: absolute; top: -1px; right: -1px; background: rgba(0,0,0,0.7); padding: 8px 20px 8px 15px; font-size: 1.1em; font-weight: 700; color: var(--primary-color); transition: all 0.5s; border-radius: 0; border: none; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 15% 100%, 0 60%); display: flex; align-items: center; gap: 8px; }
        #coin-display.updated { animation: coin-update-flash 0.6s ease-out; }
        #coin-display svg text { fill: var(--primary-color); transition: all 0.5s; }

        /* --- CONTROL CENTER --- */
        #control-center-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; cursor: pointer; z-index: 10; }
        #control-center-btn svg { width: 32px; height: 32px; color: var(--primary-color); transition: transform 0.3s; }
        #control-center-btn:hover svg { transform: rotate(90deg); }

        #control-center-modal .modal-box { width: 95%; max-width: 450px; }
        .control-center-tabs { display: flex; border-bottom: 1px solid var(--primary-color); margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; color: var(--secondary-color); font-size: 1em; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; text-align: left; }
        .stat-item, .mission-item, .store-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stat-item span:last-child, .mission-item span:last-child { font-weight: bold; color: var(--primary-color); }
        .progress-bar { width: 100px; height: 15px; background-color: #333; border-radius: 5px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: var(--success-color); width: 0%; transition: width 0.5s; }
        .claim-btn { padding: 5px 15px; background: var(--success-color); color: #000; border: none; border-radius: 5px; cursor: pointer; }
        .claim-btn:disabled { background: #555; cursor: not-allowed; }
        .store-item button { background-color: var(--primary-color); }
        .store-item button:disabled { background-color: #555; }
        .item-info { flex-grow: 1; margin-right: 10px; }
        .item-info p { margin: 0; font-size: 0.9em; opacity: 0.8; }
    </style>
</head>
<body class="theme-jarvis">
    <canvas id="matrix-canvas"></canvas>

    <div id="login-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2>YÊU CẦU MÃ TRUY CẬP CẤP CAO</h2>
            <p id="login-error"></p>
            <input type="text" id="access-code-input" class="modal-input" placeholder="NHẬP MÃ...">
            <button id="login-button" class="modal-button">XÁC THỰC</button>
        </div>
    </div>

    <div id="ultron-warning-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h2>CẢNH BÁO CHẾ ĐỘ ULTRON</h2>
            <p>ĐÂY LÀ CHẾ ĐỘ ĐẶC BIỆT TỐN 50 XU 1 LẦN, TỈ LỆ CHÍNH XÁC 99%, YÊU CẦU ĐÁNH TẤT TAY !!!</p>
            <div class="modal-button-group">
                <button id="ultron-cancel-btn" class="modal-button secondary">HỦY BỎ</button>
                <button id="ultron-confirm-btn" class="modal-button">KÍCH HOẠT</button>
            </div>
        </div>
    </div>

    <div id="control-center-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <div class="control-center-tabs">
                <button class="tab-btn active" data-tab="stats">THỐNG KÊ</button>
                <button class="tab-btn" data-tab="missions">NHIỆM VỤ</button>
                <button class="tab-btn" data-tab="store">CỬA HÀNG</button>
            </div>
            <div id="stats-tab" class="tab-content active">
                <div class="stat-item"><span>Tổng số lần quét:</span><span id="stats-total-scans">0</span></div>
                <div class="stat-item"><span>Tỷ lệ thắng Nhà Cái:</span><span id="stats-banker-rate">0%</span></div>
                <div class="stat-item"><span>Tỷ lệ thắng Tay Con:</span><span id="stats-player-rate">0%</span></div>
                <div class="stat-item"><span>Tỷ lệ Hoà:</span><span id="stats-tie-rate">0%</span></div>
                <div class="stat-item"><span>Số lần Con Đôi:</span><span id="stats-player-pair">0</span></div>
                <div class="stat-item"><span>Số lần Cái Đôi:</span><span id="stats-banker-pair">0</span></div>
            </div>
            <div id="missions-tab" class="tab-content">
                <div class="mission-item">
                    <span>Nhiệm vụ: Quét 5 lần</span>
                    <div class="progress-bar"><div id="mission-progress" class="progress-bar-inner"></div></div>
                    <button id="claim-mission-btn" class="claim-btn" disabled>Nhận 30 Xu</button>
                </div>
            </div>
            <div id="store-tab" class="tab-content">
                 <div class="store-item">
                    <div class="item-info">
                        <strong>Tăng Cường Tín Hiệu</strong>
                        <p>Giảm 50% chi phí quét cho 3 lần kế tiếp.</p>
                    </div>
                    <button id="buy-boost-btn" class="modal-button">Mua (40 Xu)</button>
                </div>
            </div>
            <button id="close-control-center-btn" class="modal-button secondary" style="margin-top: 20px;">Đóng</button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <button id="control-center-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l.34-.1a1.464 1.464 0 0 1 .872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
                </svg>
            </button>
            <h1>A.I. DIVINER PROTOCOL</h1>
            <div id="coin-display">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="20" height="20">
                    <path d="M20,2 L37.32,11 L37.32,29 L20,38 L2.68,29 L2.68,11 Z" fill="none" stroke="currentColor" stroke-width="3"></path>
                    <text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle" font-size="16" fill="currentColor" font-weight="bold">XU</text>
                </svg>
                <span id="coin-count">--</span>
            </div>
        </header>
        <main>
            <div class="ai-core-selector">
                <button class="core-button active" data-model="jarvis">J.A.R.V.I.S.</button>
                <button class="core-button" data-model="ultron">ULTRON</button>
                <button class="core-button" data-model="vision">VISION</button>
            </div>
            <div id="camera-view"><video id="camera-stream" autoplay playsinline muted></video></div>
            <div id="scan-area">
                <canvas id="progress-canvas"></canvas>
                <button id="scan-button"><span id="scan-button-text">SCAN</span></button>
            </div>
            <div id="result-display">
                <h2 id="result-text">-- STANDBY --</h2>
                <div id="confidence-score"></div>
            </div>
            <div class="roadmap-box">
                <h3>BACCARAT ROADMAP</h3>
                <canvas id="roadmap-canvas" width="370" height="96"></canvas>
            </div>
        </main>
    </div>
    
    <script>
        // --- PART 0: CONFIG & STATE ---
        const ACCESS_CODES = {
            'ALPHA01': 100, 'BRAVO07': 100, 'CHARLIE42': 100, 'DELTA99': 100, 'ECHO21': 100,
            'FOXTROT77': 100, 'GOLF18': 100, 'HOTEL05': 100, 'INDIA33': 100, 'JULIET88': 100,
            'KILO10': 100, 'LIMA64': 100, 'MIKE23': 100, 'NOVEMBER50': 100, 'OSCAR11': 100,
            'PAPA02': 100, 'QUEBEC30': 100, 'ROMEO91': 100, 'SIERRA75': 100, 'TANGO44': 100
        };
        const AI_CORES = {
            jarvis: { name: "J.A.R.V.I.S.", preScanPhrases: ["Scanning environment...", "Analyzing probabilities, sir.", "Let's see what we have here."], cost: 5 },
            ultron: { name: "ULTRON", preScanPhrases: ["Show me your pathetic luck.", "There are no strings on me.", "The only path to peace is your extinction... and this bet."], cost: 50 },
            vision: { name: "VISION", preScanPhrases: ["A thing isn't beautiful because it lasts.", "What is this wager, if not probability persevering?", "I am... analyzing."], cost: 5 }
        };
        const userPreScanPhrases = ["tất tay đi, tay này đẹp", "vốn vậy sao đánh", "nhớ là quét sảnh S.E thôi nha", "Năng lượng đang cạn", "Hôm nay là ngày đẹp để thắng", "Bạn ăn cơm chưa", "Tao mắc tè rồi"];
        
        // App State
        let currentUser = null;
        let userCoins = 0;
        let historyArray = [];
        let resultCyclingInterval;
        let currentModel = 'jarvis';
        let userData = {};

        // --- DOM ELEMENTS ---
        const loginOverlay = document.getElementById('login-overlay');
        const mainContainer = document.querySelector('.container');
        const accessCodeInput = document.getElementById('access-code-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const ultronWarningModal = document.getElementById('ultron-warning-modal');
        const controlCenterModal = document.getElementById('control-center-modal');
        const scanButton = document.getElementById('scan-button');
        const videoElement = document.getElementById('camera-stream');
        const matrixCanvas = document.getElementById('matrix-canvas');

        // --- USER & DATA MANAGEMENT ---
        function loadUserData() {
            const savedData = localStorage.getItem(`user_${currentUser}`);
            const today = new Date().toISOString().slice(0, 10);
            
            if (savedData) {
                userData = JSON.parse(savedData);
                userCoins = userData.coins;
                historyArray = userData.history || [];
            } else {
                userData = {
                    coins: ACCESS_CODES[currentUser],
                    history: [],
                    lastLogin: null,
                    missions: { scansToday: 0, claimedScanReward: false },
                    store: { boost: 0 }
                };
                // *** BUG FIX IS HERE ***
                // This line ensures the starting coins are correctly assigned to the main variable.
                userCoins = userData.coins;
            }

            // Daily Login Reward
            if (userData.lastLogin !== today) {
                userCoins += 20;
                userData.lastLogin = today;
                userData.missions = { scansToday: 0, claimedScanReward: false }; // Reset missions daily
                speak("Chào mừng trở lại. 20 xu thưởng đăng nhập đã được thêm vào tài khoản.");
            }
            
            saveUserData();
            updateCoinDisplay();
            drawRoadmap();
        }

        function saveUserData() {
            if (currentUser) {
                userData.coins = userCoins;
                userData.history = historyArray;
                localStorage.setItem(`user_${currentUser}`, JSON.stringify(userData));
            }
        }

        function authenticate(code) {
            const upperCaseCode = code.toUpperCase();
            if (ACCESS_CODES.hasOwnProperty(upperCaseCode)) {
                currentUser = upperCaseCode;
                loadUserData();
                loginOverlay.style.display = 'none';
                mainContainer.style.display = 'block';
                localStorage.setItem('diviner_session_user', currentUser);
                setupCamera();
                loadData();
            } else {
                loginError.textContent = "MÃ TRUY CẬP KHÔNG HỢP LỆ.";
                accessCodeInput.value = "";
            }
        }

        function checkSession() {
            const sessionUser = localStorage.getItem('diviner_session_user');
            if(sessionUser && ACCESS_CODES.hasOwnProperty(sessionUser)) {
                authenticate(sessionUser);
            }
        }

        // --- UI & DISPLAY FUNCTIONS ---
        function updateCoinDisplay() {
            const coinCountElement = document.getElementById('coin-count');
            const coinDisplayElement = document.getElementById('coin-display');
            if (!coinCountElement || !coinDisplayElement) return;
            coinCountElement.textContent = userCoins;
            coinDisplayElement.classList.add('updated');
            setTimeout(() => coinDisplayElement.classList.remove('updated'), 600);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                window.speechSynthesis.speak(utterance);
            }
        }

        function drawMatrix() {
            const matrixCtx = matrixCanvas.getContext('2d');
            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            const alphabet = 'アァカサタナハマヤャラワガザダバパイキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789';
            const fontSize = 16;
            const columns = matrixCanvas.width / fontSize;
            const rainDrops = Array.from({ length: columns }).fill(1);
            
            function draw() {
                matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
                matrixCtx.fillStyle = '#0F0';
                matrixCtx.font = fontSize + 'px monospace';
                for (let i = 0; i < rainDrops.length; i++) {
                    const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    matrixCtx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                    if (rainDrops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) rainDrops[i] = 0;
                    rainDrops[i]++;
                }
            }
            setInterval(draw, 33);
        }

        // --- CORE APP LOGIC ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
            } catch (err) { console.error("Camera access denied:", err); }
        }

        function startScanProcess() {
            let cost = AI_CORES[currentModel].cost;
            // Check for store boost
            if (userData.store?.boost > 0) {
                cost = Math.ceil(cost / 2);
                userData.store.boost--;
                speak(`Vật phẩm kích hoạt. Chi phí giảm còn ${cost} xu.`);
            }

            if (userCoins < cost) {
                speak(`Không đủ xu để thực hiện. Cần ${cost} xu.`);
                document.getElementById('result-text').textContent = `CẦN ${cost} XU`;
                return;
            }
            userCoins -= cost;
            updateCoinDisplay();
            
            // Update mission progress
            userData.missions.scansToday++;
            
            vibrate(50);
            const allPhrases = [...AI_CORES[currentModel].preScanPhrases, ...userPreScanPhrases];
            const randomPhrase = allPhrases[Math.floor(Math.random() * allPhrases.length)];
            speak(randomPhrase);

            scanButton.disabled = true;
            document.getElementById('confidence-score').style.opacity = 0;
            
            let progress = 0;
            const progressCanvas = document.getElementById('progress-canvas');
            const progressCtx = progressCanvas.getContext('2d');
            const progressInterval = setInterval(() => {
                progress++;
                drawProgress(progressCtx, progress);
                document.getElementById('scan-button-text').textContent = `${progress}%`;
                if (progress >= 100) clearInterval(progressInterval);
            }, 4000 / 100);

            setTimeout(() => {
                resultCyclingInterval = setInterval(() => {
                    document.getElementById('result-text').textContent = ["TAY CON", "NHÀ CÁI", "HOÀ"][Math.floor(Math.random() * 3)];
                }, 100);
            }, 2500);

            setTimeout(() => {
                clearInterval(resultCyclingInterval);
                vibrate([100, 30, 100]);
                
                let finalResult = generateRandomResult();
                updateHistory(finalResult);
                displayResult(finalResult);
                
                scanButton.disabled = false;
                document.getElementById('scan-button-text').textContent = "SCAN";
                progressCtx.clearRect(0, 0, 150, 150);
                saveUserData();
            }, 4000);
        }
        
        function generateRandomResult() {
            const mainResult = ["Tay con", "Nhà cái", "Hoà"][Math.floor(Math.random() * 3)];
            if (mainResult === "Hoà") return { winner: "Hoà", pairs: [] };
            let pairs = [];
            if (Math.random() < 0.075) pairs.push("Con đôi");
            if (Math.random() < 0.075) pairs.push("Cái đôi");
            return { winner: mainResult, pairs: pairs };
        }

        function displayResult(result) {
            const resultString = [result.winner, ...result.pairs].join(" - ").toUpperCase();
            document.getElementById('result-text').textContent = resultString;
            
            let minConfidence = currentModel === 'ultron' ? 99.0 : 92.5;
            let maxConfidence = currentModel === 'ultron' ? 99.8 : 98.5;
            const randomConfidence = (Math.random() * (maxConfidence - minConfidence) + minConfidence).toFixed(1);
            document.getElementById('confidence-score').textContent = `CONFIDENCE: ${randomConfidence}%`;
            document.getElementById('confidence-score').style.opacity = 1;
            speak(`Kết quả: ${result.winner}. Độ tự tin: ${randomConfidence} phần trăm.`);
        }

        function drawRoadmap() {
            const roadmapCanvas = document.getElementById('roadmap-canvas');
            const roadmapCtx = roadmapCanvas.getContext('2d');
            const roadmapCellSize = 16;
            roadmapCtx.clearRect(0, 0, roadmapCanvas.width, roadmapCanvas.height);
            let col = 0, row = 0;
            if (historyArray.length === 0) return;
            for (let i = 0; i < historyArray.length; i++) {
                if (i > 0 && historyArray[i].winner !== historyArray[i-1].winner && historyArray[i-1].winner !== 'Hoà') { col++; row = 0; }
                if (row >= 6) { col++; row = 0; }
                if (col >= 23) break;
                const x = col * roadmapCellSize + roadmapCellSize / 2;
                const y = row * roadmapCellSize + roadmapCellSize / 2;
                if (historyArray[i].winner === "Hoà") {
                    if(i > 0) row--;
                    roadmapCtx.beginPath(); roadmapCtx.moveTo(x - 5, y - 5); roadmapCtx.lineTo(x + 5, y + 5);
                    roadmapCtx.strokeStyle = '#00ff00'; roadmapCtx.lineWidth = 2; roadmapCtx.stroke();
                } else {
                    roadmapCtx.beginPath(); roadmapCtx.arc(x, y, roadmapCellSize / 2 - 2, 0, 2 * Math.PI);
                    roadmapCtx.strokeStyle = historyArray[i].winner === 'Tay con' ? '#00bfff' : '#ff1a1a';
                    roadmapCtx.lineWidth = 2; roadmapCtx.stroke();
                }
                row++;
            }
        }

        function updateHistory(result) {
            historyArray.push(result);
            if (historyArray.length > 50) historyArray.shift();
            drawRoadmap();
        }

        function changeModel(model) {
            if (model === 'ultron' && currentModel !== 'ultron') {
                if (userCoins < AI_CORES.ultron.cost) {
                    speak(`Không đủ xu để kích hoạt ULTRON. Cần ${AI_CORES.ultron.cost} xu.`);
                    return;
                }
                ultronWarningModal.style.display = 'flex';
                return;
            }
            applyModelChange(model);
        }

        function applyModelChange(model) {
            currentModel = model;
            document.body.className = `theme-${model}`;
            document.querySelectorAll('.core-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.core-button[data-model="${model}"]`).classList.add('active');
            localStorage.setItem('baccaratModel', model);
        }

        function loadData() {
            const savedModel = localStorage.getItem('baccaratModel');
            if (savedModel) applyModelChange(savedModel);
        }
        
        function vibrate(p) { if ('vibrate' in navigator) navigator.vibrate(p); }
        function drawProgress(ctx, p) {
            const r=75; const a=(p/100)*2*Math.PI-0.5*Math.PI;
            ctx.clearRect(0,0,150,150); ctx.beginPath();
            ctx.arc(r,r,r-10,-0.5*Math.PI,a,false); ctx.lineWidth=4;
            ctx.strokeStyle='var(--primary-color)'; ctx.stroke();
        }

        // --- CONTROL CENTER LOGIC ---
        function updateStats() {
            const total = historyArray.length;
            document.getElementById('stats-total-scans').textContent = total;
            if (total === 0) {
                 document.getElementById('stats-banker-rate').textContent = `0%`;
                 document.getElementById('stats-player-rate').textContent = `0%`;
                 document.getElementById('stats-tie-rate').textContent = `0%`;
                 document.getElementById('stats-player-pair').textContent = 0;
                 document.getElementById('stats-banker-pair').textContent = 0;
                 return;
            };
            const bankerWins = historyArray.filter(h => h.winner === 'Nhà cái').length;
            const playerWins = historyArray.filter(h => h.winner === 'Tay con').length;
            const ties = historyArray.filter(h => h.winner === 'Hoà').length;
            const playerPairs = historyArray.reduce((acc, h) => acc + (h.pairs.includes('Con đôi') ? 1 : 0), 0);
            const bankerPairs = historyArray.reduce((acc, h) => acc + (h.pairs.includes('Cái đôi') ? 1 : 0), 0);
            
            document.getElementById('stats-banker-rate').textContent = `${((bankerWins / total) * 100).toFixed(1)}%`;
            document.getElementById('stats-player-rate').textContent = `${((playerWins / total) * 100).toFixed(1)}%`;
            document.getElementById('stats-tie-rate').textContent = `${((ties / total) * 100).toFixed(1)}%`;
            document.getElementById('stats-player-pair').textContent = playerPairs;
            document.getElementById('stats-banker-pair').textContent = bankerPairs;
        }

        function updateMissions() {
            if (!userData.missions) return;
            const scans = userData.missions.scansToday;
            const progress = Math.min((scans / 5) * 100, 100);
            document.getElementById('mission-progress').style.width = `${progress}%`;
            
            const claimBtn = document.getElementById('claim-mission-btn');
            if (scans >= 5 && !userData.missions.claimedScanReward) {
                claimBtn.disabled = false;
            } else {
                claimBtn.disabled = true;
            }
        }
        
        function claimMissionReward() {
            if (userData.missions.scansToday >= 5 && !userData.missions.claimedScanReward) {
                userCoins += 30;
                userData.missions.claimedScanReward = true;
                updateCoinDisplay();
                saveUserData();
                updateMissions();
                speak("Đã nhận thưởng 30 xu.");
            }
        }
        
        function buyBoost() {
            const cost = 40;
            if (userCoins >= cost) {
                userCoins -= cost;
                if (!userData.store) userData.store = {};
                userData.store.boost = (userData.store.boost || 0) + 3;
                updateCoinDisplay();
                saveUserData();
                speak("Đã mua Tăng Cường Tín Hiệu.");
            } else {
                speak("Không đủ xu để mua vật phẩm này.");
            }
        }

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', () => authenticate(accessCodeInput.value));
        accessCodeInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') authenticate(accessCodeInput.value); });
        document.querySelectorAll('.core-button').forEach(button => button.addEventListener('click', () => changeModel(button.dataset.model)));
        document.getElementById('ultron-confirm-btn').addEventListener('click', () => { ultronWarningModal.style.display = 'none'; applyModelChange('ultron'); });
        document.getElementById('ultron-cancel-btn').addEventListener('click', () => { ultronWarningModal.style.display = 'none'; });
        scanButton.addEventListener('click', startScanProcess);
        
        // Control Center Listeners
        document.getElementById('control-center-btn').addEventListener('click', () => {
            updateStats();
            updateMissions();
            controlCenterModal.style.display = 'flex';
        });
        document.getElementById('close-control-center-btn').addEventListener('click', () => { controlCenterModal.style.display = 'none'; });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
            });
        });
        document.getElementById('claim-mission-btn').addEventListener('click', claimMissionReward);
        document.getElementById('buy-boost-btn').addEventListener('click', buyBoost);
        
        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            checkSession();
            drawMatrix();
        });
    </script>
</body>
</html>
